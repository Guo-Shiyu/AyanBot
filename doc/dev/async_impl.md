# 异步 API Call 实现 
阅读本文前请参阅 [通信]() 一节中内容.   

## Echo 字段、 Hook 表
沿 WebSocket 推送数据包到协议适配器时, 包中有一个数字型字段 echo, 每次调用 API 后, 无论是否有其他数据返回, 该字段都将被原封不动地返回. Ayan 通过为每个调用生成不同的 echo 字段来区别同一个 Bot 实例上并发的 api 调用.  

每个针对 api 调用结果的回调函数在 Ayan 中被命名为 hook, 当调用发生后, echo 字段的值将被记录在 bot 的回调表中(见 Bot:: hooks_). 回调表将返回值映射到用户设置的回调函数上， 在用户不设置任何回调的情况下， Ayan 将会默认地为该次调用生成一个 Ignore Hook, 这是一个空函数， 不会有任何副作用。 

特别地, echo 字段为 0 时被约定为无返回值的情况, 此时不会被加入回调表, 当被动收到 echo 字段为 0 的数据包时, 该包会被忽略， 但仍然会调用回调表中用户设置的回调函数. 

对于那些有返回值的结果, 则 Ayan 会自动地将 packet 中的字节流 parse 成 C++ 中的返回结果类(见 apiimpl.h 中各 api 返回结果的定义), 再以返回结果作为参数调用回调表中的用户设置的回调函数.

## 基于回调的异步   
在上述机制的支持下， 基于回调的异步 API 只是在回调表中注册了用户自定义的回调函数而非默认的 Ignore Hook 而已。  

## 基于 future 的异步 
future 异步也是基于回调表的实现。 其使用捕获了 promise 对象的特殊回调取代默认的 Ignore Hook。   

具体流程为： 在注册回调表之前产生一个 promise(std::promise)对象， 将 promise 对象伴随的 future 返回给用户接口。 在特殊回调中， 将已经 parse 成调用结果的返回值通过 std::promise::set_value() 接口填充到 future 对象中即可。在先前用户拿到的 future 对象中则可 通过 get() 接口异步地获取结果。

## 可能的异常情况
在注册回调表的同时也会启动一个超时定时器, 在特定时间(通常是 10s, 见 Bot::MaxHookTime )后清除回调表中的该回调函数, 因此由于不可知原因造成的 OneBot API 调用无结果, 其回调函数将不会被触发， 若是使用 future 对象， 则可能造成 get 方法阻塞.

